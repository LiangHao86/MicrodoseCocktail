;; 1. Based on: 
;; 2. Description: ATV base model

$PROB  Base model
$ABBR DERIV2=NO
$DATA ATV_PKcov_20240126_GUT_20240417.csv IGNORE=@
$INPUT  ID,  TIME, DV, AMT, MDV, EVID, CMT, POP, Haem

$SUBROUTINES  ADVAN13  TOL=5 

$MODEL NCOMPARTMENTS=3
COMP=(DEPOT,DEFDOSE)
COMP=(CENTRAL,DEFOBS)
COMP=(PER)

$PK
TVCL     = THETA(1) 
CL       = TVCL* EXP(ETA(1))

TVVC     = THETA(2)
VC       = TVVC * EXP(ETA(2)) 

TVKA     = THETA(3) 
KA       = TVKA* EXP(ETA(3))

TVVP     = THETA(4)
VP       = TVVP * EXP(ETA(4))

TVCLD     = THETA(5)
CLD       = TVCLD * EXP(ETA(5))

;;;;;;;;;;;;;;;;;Initial Value ;;;;;;;;;;;;;;;;;;
;A_0FLG is set by NONMEM for the first record of each subject (i.e. NEWIND.LE.0)
IF (A_0FLG.EQ.1) THEN
A_0(1)   = 0
A_0(2)   = 0
ENDIF


$DES
C1      =  A(2)/VC
C2      =  A(3)/VP
DADT(1) = -KA*A(1)
DADT(2) =  KA*A(1)-C1*(CL+CLD)+C2*CLD
DADT(3) =  C1*CLD-C2*CLD

$THETA  

(0,320, 1000)            ;CL  
(0, 889, 5000)         ;VC
(0, 20, 100)           ;KA
(0, 6320 10000)        ;VT
(0, 4000, 6000)            ;CLd



$OMEGA  
0.232               ;ETA_CL
0.7                    ; ETA_VC
0 FIX                   ;ETA_KA
0.413               ; ETA_VT
0.09               ; ETA_CLD


$ERROR
IF (CMT.EQ.2) IPRED = A(2)/VC 
IRES = DV-IPRED
W    =IPRED
DEL = 0
IF(W.EQ.0) DEL = 1
IWRES = IRES/(W+DEL)
Y = IPRED+EPS(1)*W+EPS(2)

$SIGMA  
0.09  
0.09

;$ESTIMATION MAXEVALS=9999 METHOD=1 INTER NONINFETA=1 ITER=9999
;$ESTIMATION METHOD=IMPMAP MAPITER=0 ISAMPLE=5000 NITER=15 EONLY=1
;$COVARIANCE UNCON

;$ESTIMATION MAXEVALS=9000 METHOD=1 INTER NONINFETA=1
;$COVARIANCE UNCONDITIONAL MATRIX=R SIRNITER=3

$EST MAXEVAL=9999 METHOD=1 INTER PRINT=1 SIGDIGITS=2 NOABORT NOTBT NOOBT NOSBT
$COV MATRIX=R  PRINT=E
$TABLE ID TIME CMT DV AMT MDV IPRED PRED IWRES RES IRES CWRES WRES ONEHEADER NOPRINT FILE=sdtabATV.tab
$TABLE ID KA CL VC VP CLD ETA1 ETA2 ETA3 ETA4 ETA5 FILE=PATATV.tab ONEHEADER NOPRINT FIRSTONLY
